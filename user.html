<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2563EB" />
  <title>Free Fire Tournaments – Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary:   #F8FAFC;    /* soft white */
      --bg-secondary: #E2E8F0;    /* light gray */
      --text-dark:    #1E293B;    /* rich dark text */
      --accent-blue:  #2563EB;    /* brand blue */
      --accent-gold:  #FBBF24;    /* prize gold */
      --accent-red:   #DC2626;    /* alerts/danger */
      --border:       #CBD5E1;    /* soft outline */
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text-dark);
      background: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1, h2, h3, .brand {
      font-family: 'Russo One', sans-serif;
      letter-spacing: 0.3px;
    }

    .app-shell {
      max-width: 780px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
    }

    header.app-header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,0.9));
      border-bottom: 1px solid var(--border);
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 8px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
    }
    .brand .logo {
      width: 28px; height: 28px; border-radius: 8px; background: var(--accent-blue);
      display: grid; place-items: center; color: white;
    }

    .segmented {
      display: grid;
      grid-auto-flow: column;
      gap: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px;
    }
    .segmented button {
      appearance: none;
      border: 0;
      background: transparent;
      padding: 10px 12px;
      border-radius: 8px;
      font-weight: 600;
      color: #334155;
      transition: background 140ms ease, color 140ms ease, transform 80ms ease;
    }
    .segmented button.active { background: #fff; color: var(--accent-blue); box-shadow: 0 1px 0 rgba(0,0,0,0.02), inset 0 0 0 1px var(--border);} 
    .segmented button:active { transform: translateY(1px); }

    .container { padding: 16px 8px 40px; }

    .hero {
      background: linear-gradient(135deg, #fff, #eef6ff);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      display: grid; gap: 10px;
    }
    .hero h1 { margin: 0; font-size: 22px; }
    .hero p { margin: 0; color: #475569; }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text-dark);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      transition: transform 80ms ease, box-shadow 140ms ease, background 140ms ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--accent-blue); color: white; border-color: transparent; }
    .btn.gold { background: var(--accent-gold); color: #1f2937; border-color: transparent; }
    .btn.red { background: var(--accent-red); color: white; border-color: transparent; }
    .btn.ghost { background: transparent; }

    .grid { display: grid; gap: 12px; }
    @media (min-width: 560px) { .grid.cols-2 { grid-template-columns: repeat(2, 1fr); } }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      display: grid; gap: 8px;
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .muted { color: #64748B; font-size: 12px; }
    .title { font-weight: 800; }
    .pill { padding: 4px 8px; border-radius: 999px; background: var(--bg-secondary); font-size: 11px; font-weight: 700; color: #334155; border: 1px solid var(--border); }
    .pill.gold { background: #FFFBEB; border-color: #FDE68A; color: #B45309; }
    .pill.red { background: #FEF2F2; border-color: #FCA5A5; color: #991B1B; }

    .tourn-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .meta {
      display: flex; align-items: center; gap: 6px; color: #475569; font-size: 13px;
    }

    .divider { height: 1px; background: var(--border); margin: 4px 0; }

    .input, textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #fff;
      font-size: 14px;
    }
    label { font-size: 12px; color: #475569; font-weight: 700; }
    .field { display: grid; gap: 6px; }
    .form { display: grid; gap: 12px; }

    .tabs { display: none; }
    .tabs.active { display: block; }

    dialog.modal {
      border: 0; border-radius: 16px; padding: 0; max-width: 520px; width: 92vw;
      box-shadow: 0 20px 50px rgba(0,0,0,0.18);
    }
    .modal .modal-head { padding: 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal .modal-body { padding: 14px; display: grid; gap: 12px; }
    .modal .modal-foot { padding: 12px 14px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
    .close-x { background: transparent; border: 0; font-size: 20px; line-height: 1; padding: 4px; cursor: pointer; }

    .wallet {
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
      background: linear-gradient(135deg, #e0edff, #fff);
      border: 1px solid var(--border); border-radius: var(--radius); padding: 12px;
    }
    .avatar { width: 48px; height: 48px; border-radius: 12px; background: #e2e8f0; display: grid; place-items: center; font-weight: 900; color: #334155; }
    .list { display: grid; gap: 8px; }

    .floating-action {
      position: fixed; right: 18px; bottom: calc(18px + env(safe-area-inset-bottom)); z-index: 40;
    }

    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; background: #1f2937; color: #fff; padding: 10px 14px; border-radius: 12px; font-weight: 700; display: none; }
    .toast.show { display: inline-block; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-shell header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12L12 3L21 12L12 21L3 12Z" fill="white" fill-opacity=".9"/>
          </svg>
        </div>
        <span>Free Fire Tournaments</span>
      </div>
      <div class="segmented" role="tablist" aria-label="Main tabs">
        <button class="tab-btn active" data-tab="home" role="tab" aria-selected="true">Home</button>
        <button class="tab-btn" data-tab="tournaments" role="tab" aria-selected="false">Tournaments</button>
        <button class="tab-btn" data-tab="refer" role="tab" aria-selected="false">Refer & Earn</button>
        <button class="tab-btn" data-tab="profile" role="tab" aria-selected="false">Profile</button>
      </div>
    </div>
  </header>

  <main class="app-shell container">
    <section id="home" class="tabs active" aria-labelledby="home">
      <div class="hero">
        <h1>Jump into esports. Win real prizes.</h1>
        <p>Daily Free Fire rooms, fair rules, instant wallet payouts. Play on mobile, anywhere.</p>
        <div class="row">
          <button class="btn primary" id="ctaPlayNow">Play Now</button>
          <span class="pill gold">Prize Pool Live</span>
        </div>
      </div>
      <div class="grid" style="margin-top:12px;">
        <div class="card">
          <div class="row">
            <div class="title">How it works</div>
            <span class="pill">3 steps</span>
          </div>
          <div class="grid cols-2">
            <div><span class="muted">1.</span> Pick a tournament from Live tab</div>
            <div><span class="muted">2.</span> Join with your FF UID</div>
            <div><span class="muted">3.</span> Get room ID/Pass & play</div>
            <div><span class="muted">+</span> Withdraw prizes to wallet</div>
          </div>
        </div>
      </div>
    </section>

    <section id="tournaments" class="tabs" aria-labelledby="tournaments">
      <div class="row" style="margin-bottom:8px;">
        <div class="segmented" aria-label="Tournament filters">
          <button class="seg-btn active" data-filter="live">Live</button>
          <button class="seg-btn" data-filter="upcoming">Upcoming</button>
          <button class="seg-btn" data-filter="past">Past</button>
        </div>
        <button id="refreshTournaments" class="btn ghost">Refresh</button>
      </div>
      <div id="tournamentList" class="grid"></div>
    </section>

    <section id="refer" class="tabs" aria-labelledby="refer">
      <div class="card">
        <div class="row">
          <div class="title">Refer & Earn</div>
          <span class="pill gold">Bonus</span>
        </div>
        <div class="grid">
          <div class="field">
            <label>Your referral link</label>
            <div class="row">
              <input id="refLink" class="input" readonly />
              <button id="copyRef" class="btn">Copy</button>
            </div>
          </div>
          <div class="row">
            <button id="shareSystem" class="btn primary">Share</button>
            <button id="shareWhatsApp" class="btn">WhatsApp</button>
            <button id="shareTelegram" class="btn">Telegram</button>
          </div>
          <div class="divider"></div>
          <div class="row">
            <div>Referral credits earned</div>
            <div><span id="refCredits" class="pill gold">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="profile" class="tabs" aria-labelledby="profile">
      <div class="card">
        <div class="row">
          <div class="avatar" id="avatar">FF</div>
          <div class="wallet" style="flex:1;">
            <div>
              <div class="muted">Wallet Balance</div>
              <div style="font-weight:900; font-size:18px;" id="walletBalance">₹0</div>
            </div>
            <button id="btnTopup" class="btn gold">Top-up</button>
          </div>
        </div>
        <div class="form" style="margin-top:8px;">
          <div class="field">
            <label>Name</label>
            <input id="profileName" class="input" placeholder="Your name" />
          </div>
          <div class="field">
            <label>Free Fire UID</label>
            <input id="profileUID" class="input" placeholder="987654321" />
          </div>
          <div class="row" style="justify-content:flex-end;">
            <button id="saveProfile" class="btn primary">Save Profile</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="row"><div class="title">My Registrations</div><button id="refreshRegs" class="btn ghost">Refresh</button></div>
        <div id="myRegistrations" class="list"></div>
      </div>
    </section>
  </main>

  <div class="floating-action">
    <button id="fabJoin" class="btn primary">+ Join</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <dialog id="joinModal" class="modal">
    <div class="modal-head">
      <div class="title">Join Tournament</div>
      <button class="close-x" data-close>×</button>
    </div>
    <div class="modal-body">
      <form id="joinForm" class="form">
        <input type="hidden" id="joinTournId" />
        <div class="field">
          <label>Player Name</label>
          <input id="joinName" class="input" required />
        </div>
        <div class="field">
          <label>Free Fire UID</label>
          <input id="joinUID" class="input" required />
        </div>
        <div class="field">
          <label>Entry Fee</label>
          <input id="joinEntry" class="input" readonly />
        </div>
      </form>
      <div id="insufficient" class="muted hidden">Insufficient balance. Top-up and continue.</div>
      <div id="joinAnim" class="hidden" style="display:grid; place-items:center; padding:8px;">
        <div id="lottieJoin" style="width:96px; height:96px;"></div>
        <div style="font-weight:800;">You're in!</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" data-close>Cancel</button>
      <button id="btnPayAndJoin" class="btn primary">Pay & Join</button>
      <button id="btnConfirmJoin" class="btn gold">Join</button>
    </div>
  </dialog>

  <dialog id="topupModal" class="modal">
    <div class="modal-head">
      <div class="title">Top-up Wallet</div>
      <button class="close-x" data-close>×</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Amount (₹)</label>
        <input id="topupAmount" type="number" min="10" step="10" value="50" class="input" />
      </div>
      <div class="muted">Powered by Razorpay/Stripe (sandbox placeholder)</div>
    </div>
    <div class="modal-foot">
      <button class="btn" data-close>Close</button>
      <button id="btnTopupPay" class="btn primary">Pay & Add</button>
    </div>
  </dialog>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js" integrity="sha512-Fg8lztClLCj5wA0QShTnM3N0s3XvTtOM6gY3YknJGr3oZg2D1/o7vYNUVJr8yT0v3ex7JkFifGv4ba3jE94b7g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Firebase / Firestore config placeholder
    // eslint-disable-next-line no-unused-vars
    const firebaseConfig = { /* TODO: add your Firebase project keys */ };
    // eslint-disable-next-line no-unused-vars
    const firebase = { initializeApp: () => {}, auth: () => ({ onAuthStateChanged: () => {} }) };
    // const app = firebase.initializeApp(firebaseConfig);
    // const db = firebase.firestore();

    // Basic state and storage
    const STORAGE_KEY = 'ff_app_data_v1';
    const nowIso = () => new Date().toISOString();
    const currency = (v) => `₹${Number(v || 0).toFixed(0)}`;
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function uid() { return 'id_' + Math.random().toString(36).slice(2, 10); }

    // Seed demo data
    function seed() {
      const state = loadState() || {};
      if (!state.settings) {
        state.settings = { paymentGateway: 'razorpay', razorpayKey: '', stripeKey: '', referralBonus: 10 };
      }
      if (!state.users) {
        const userId = uid();
        state.currentUserId = userId;
        state.users = {
          [userId]: { id: userId, name: 'Rohan', avatar: '', ffuid: '987654321', walletBalance: 80, referrer: '', credits: 0, createdAt: Date.now(), firstJoinCredited: false }
        };
      }
      if (!state.tournaments) {
        const base = Date.now();
        const make = (offsetHours, title, map, prize, entryFee, maxPlayers) => {
          const id = uid();
          return [id, { id, title, matchTime: new Date(base + offsetHours * 3600e3).toISOString(), map, prize, entryFee, roomId: '', roomPass: '', maxPlayers, status: 'open', createdAt: Date.now(), registrations: [] }];
        };
        const pairs = [
          make(-1, 'Sunset Skirmish', 'Bermuda', 1000, 20, 100),
          make(1, 'Midnight Clash', 'Kalahari', 1500, 30, 100),
          make(5, 'Dawn Rush', 'Purgatory', 2000, 40, 100),
          make(-5, 'Retro Royale', 'Bermuda', 800, 10, 80)
        ];
        state.tournaments = Object.fromEntries(pairs);
      }
      if (!state.payments) state.payments = [];
      if (!state.referrals) state.referrals = [];
      saveState(state);
    }

    // Global state
    seed();
    let appState = loadState();

    // Referral param capture
    (function captureRef() {
      const params = new URLSearchParams(location.search);
      const ref = params.get('ref');
      const user = currentUser();
      if (ref && user && !user.referrer && ref !== user.id) {
        user.referrer = ref;
        appState.referrals.push({ id: uid(), referrer: ref, referred: user.id, timestamp: Date.now() });
        save();
      }
    })();

    function currentUser() { return appState.users[appState.currentUserId]; }
    function save() { saveState(appState); appState = loadState(); renderAll(); }

    // UI helpers
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
    function toast(msg) {
      const el = qs('#toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1800);
    }

    // Tabs
    qsa('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
    function switchTab(tab) {
      qsa('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
      qsa('.tabs').forEach(s => s.classList.toggle('active', s.id === tab));
      if (tab === 'tournaments') renderTournaments();
      if (tab === 'refer') renderRefer();
      if (tab === 'profile') renderProfile();
    }
    qs('#ctaPlayNow').addEventListener('click', () => switchTab('tournaments'));

    // Render functions
    function classifyTournaments() {
      const list = Object.values(appState.tournaments);
      const now = Date.now();
      const live = [], upcoming = [], past = [];
      list.forEach(t => {
        const tms = new Date(t.matchTime).getTime();
        if (Math.abs(now - tms) < 60*60*1000) live.push(t);
        else if (tms > now) upcoming.push(t);
        else past.push(t);
      });
      return { live, upcoming, past };
    }

    let currentFilter = 'live';
    qsa('.seg-btn').forEach(btn => btn.addEventListener('click', () => { currentFilter = btn.dataset.filter; qsa('.seg-btn').forEach(b=>b.classList.toggle('active', b===btn)); renderTournaments(); }));
    qs('#refreshTournaments').addEventListener('click', renderTournaments);

    function renderTournaments() {
      const { live, upcoming, past } = classifyTournaments();
      const data = currentFilter === 'live' ? live : currentFilter === 'upcoming' ? upcoming : past;
      const list = qs('#tournamentList');
      list.innerHTML = '';
      if (!data.length) {
        list.innerHTML = '<div class="muted">No tournaments here yet. Check other tabs.</div>';
        return;
      }
      data.sort((a,b)=> new Date(a.matchTime)-new Date(b.matchTime));
      data.forEach(t => list.appendChild(tournamentCard(t)));
    }

    function tournamentCard(t) {
      const el = document.createElement('div');
      el.className = 'card';
      const regs = t.registrations.length;
      el.innerHTML = `
        <div class="row">
          <div class="title">${t.title}</div>
          <span class="pill gold">${currency(t.prize)}</span>
        </div>
        <div class="tourn-meta">
          <div class="meta">🕒 <span>${new Date(t.matchTime).toLocaleString()}</span></div>
          <div class="meta">🗺️ <span>${t.map}</span></div>
          <div class="meta">👥 <span>${regs}/${t.maxPlayers}</span></div>
          <div class="meta">💳 <span>${currency(t.entryFee)}</span></div>
        </div>
        <div class="row">
          <span class="pill">${statusLabel(t)}</span>
          <div style="display:flex; gap:8px;">
            <button class="btn" data-id="${t.id}" data-action="details">Details</button>
            <button class="btn primary" data-id="${t.id}" data-action="join">Join</button>
          </div>
        </div>
      `;
      el.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === 'join') openJoinModal(id);
        if (action === 'details') alert(detailsText(appState.tournaments[id]));
      });
      return el;
    }

    function statusLabel(t) {
      const tms = new Date(t.matchTime).getTime();
      const now = Date.now();
      if (Math.abs(now - tms) < 60*60*1000) return 'Live soon';
      if (tms > now) return 'Upcoming';
      return 'Completed';
    }
    function detailsText(t) {
      return `${t.title}\nTime: ${new Date(t.matchTime).toLocaleString()}\nMap: ${t.map}\nPrize: ${currency(t.prize)}\nEntry: ${currency(t.entryFee)}\nMax: ${t.maxPlayers}`;
    }

    function renderRefer() {
      const user = currentUser();
      const link = location.origin + location.pathname + `?ref=${user.id}`;
      qs('#refLink').value = link;
      qs('#refCredits').textContent = currency(user.credits || 0);
    }

    function renderProfile() {
      const user = currentUser();
      qs('#profileName').value = user.name || '';
      qs('#profileUID').value = user.ffuid || '';
      qs('#walletBalance').textContent = currency(user.walletBalance);
      qs('#avatar').textContent = (user.name || 'FF').slice(0,2).toUpperCase();
      renderMyRegistrations();
    }

    function renderMyRegistrations() {
      const user = currentUser();
      const regs = Object.values(appState.tournaments).flatMap(t => (t.registrations||[]).filter(r => r.userId === user.id).map(r => ({ t, r })));
      const list = qs('#myRegistrations');
      list.innerHTML = '';
      if (!regs.length) { list.innerHTML = '<div class="muted">No registrations yet.</div>'; return; }
      regs.sort((a,b)=> new Date(a.t.matchTime) - new Date(b.t.matchTime));
      regs.forEach(({t}) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div>
            <div style="font-weight:800; font-size:14px;">${t.title}</div>
            <div class="muted">${new Date(t.matchTime).toLocaleString()} • ${t.map}</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn" data-id="${t.id}" data-action="showRoom">Room</button>
            <button class="btn red" data-id="${t.id}" data-action="cancel">Cancel</button>
          </div>
        `;
        row.addEventListener('click', (e)=>{
          const b = e.target.closest('button'); if (!b) return;
          if (b.dataset.action==='cancel') cancelRegistration(b.dataset.id);
          if (b.dataset.action==='showRoom') showRoomInfo(b.dataset.id);
        });
        list.appendChild(row);
      });
    }

    function showRoomInfo(tid) {
      const t = appState.tournaments[tid];
      if (!t.roomId) { toast('Room details share soon'); return; }
      alert(`Room ID: ${t.roomId}\nPass: ${t.roomPass || '-'}\nJoin on time!`);
    }

    // Share actions
    qs('#copyRef').addEventListener('click', async () => {
      await navigator.clipboard.writeText(qs('#refLink').value);
      toast('Copied link');
    });
    qs('#shareSystem').addEventListener('click', async () => {
      const url = qs('#refLink').value;
      if (navigator.share) {
        try { await navigator.share({ title: 'Join Free Fire tourneys', text: 'Use my link to earn bonus!', url }); } catch {}
      } else { await navigator.clipboard.writeText(url); toast('Copied link'); }
    });
    qs('#shareWhatsApp').addEventListener('click', () => {
      const url = encodeURIComponent(qs('#refLink').value);
      const text = encodeURIComponent('Join Free Fire tournaments with me! ');
      location.href = `https://wa.me/?text=${text}${url}`;
    });
    qs('#shareTelegram').addEventListener('click', () => {
      const url = encodeURIComponent(qs('#refLink').value);
      const text = encodeURIComponent('Join Free Fire tournaments with me! ');
      location.href = `https://t.me/share/url?url=${url}&text=${text}`;
    });

    // Profile save
    qs('#saveProfile').addEventListener('click', () => {
      const user = currentUser();
      user.name = qs('#profileName').value.trim();
      user.ffuid = qs('#profileUID').value.trim();
      save();
      toast('Profile saved');
    });
    qs('#refreshRegs').addEventListener('click', renderMyRegistrations);

    // Floating quick join opens tournaments tab
    qs('#fabJoin').addEventListener('click', () => switchTab('tournaments'));

    // Join modal
    function openJoinModal(tid) {
      const user = currentUser();
      const t = appState.tournaments[tid];
      qs('#joinTournId').value = tid;
      qs('#joinName').value = user.name || '';
      qs('#joinUID').value = user.ffuid || '';
      qs('#joinEntry').value = currency(t.entryFee);
      qs('#insufficient').classList.add('hidden');
      qs('#btnPayAndJoin').classList.remove('hidden');
      qs('#btnConfirmJoin').classList.remove('hidden');
      qs('#joinAnim').classList.add('hidden');
      qs('#joinModal').showModal();
    }
    qsa('[data-close]').forEach(b => b.addEventListener('click', (e)=> e.target.closest('dialog').close()))

    function ensureProfileForJoin() {
      const name = qs('#joinName').value.trim();
      const uid = qs('#joinUID').value.trim();
      if (!name || !uid) { toast('Enter name and FF UID'); return false; }
      const user = currentUser(); user.name = name; user.ffuid = uid; return true;
    }

    async function handleJoin() {
      if (!ensureProfileForJoin()) return;
      const tid = qs('#joinTournId').value;
      const t = appState.tournaments[tid];
      const user = currentUser();
      if ((t.registrations||[]).some(r => r.userId === user.id)) { toast('Already joined'); return; }
      if (user.walletBalance < t.entryFee) {
        qs('#insufficient').classList.remove('hidden');
        toast('Insufficient balance');
        return;
      }
      user.walletBalance -= t.entryFee;
      t.registrations.push({ userId: user.id, timestamp: Date.now() });
      maybeCreditReferrerOnFirstJoin(user);
      save();
      playJoinAnimation();
    }
    qs('#btnConfirmJoin').addEventListener('click', handleJoin);

    function playJoinAnimation() {
      qs('#btnPayAndJoin').classList.add('hidden');
      qs('#btnConfirmJoin').classList.add('hidden');
      qs('#joinAnim').classList.remove('hidden');
      try {
        lottie.loadAnimation({ container: qs('#lottieJoin'), renderer: 'svg', loop: false, autoplay: true, path: 'https://assets6.lottiefiles.com/packages/lf20_myejiggj.json' });
      } catch {}
      setTimeout(() => { qs('#joinModal').close(); toast('Joined successfully'); }, 1100);
    }

    function maybeCreditReferrerOnFirstJoin(user) {
      if (!user.referrer || user.firstJoinCredited) return;
      const bonus = Number(appState.settings.referralBonus || 0);
      if (!bonus) return;
      const refUser = appState.users[user.referrer];
      if (!refUser) return;
      refUser.walletBalance += bonus;
      refUser.credits = (refUser.credits || 0) + bonus;
      user.firstJoinCredited = true;
    }

    // Cancel registration (simple full refund if event not started)
    function cancelRegistration(tid) {
      const t = appState.tournaments[tid]; const user = currentUser();
      const timeMs = new Date(t.matchTime).getTime();
      if (Date.now() > timeMs - 10*60*1000) { toast('Too late to cancel'); return; }
      const i = t.registrations.findIndex(r => r.userId === user.id);
      if (i === -1) { toast('Not registered'); return; }
      t.registrations.splice(i,1);
      user.walletBalance += t.entryFee;
      save(); toast('Registration cancelled');
    }

    // Top-up modal actions
    qs('#btnTopup').addEventListener('click', () => { qs('#topupAmount').value = 50; qs('#topupModal').showModal(); });
    qs('#btnTopupPay').addEventListener('click', async () => {
      const amount = Number(qs('#topupAmount').value || 0);
      if (amount < 10) { toast('Min ₹10'); return; }
      const ok = await processPayment(amount, 'Wallet Top-up');
      if (!ok) { toast('Payment failed'); return; }
      currentUser().walletBalance += amount;
      appState.payments.push({ id: uid(), userId: currentUser().id, amount, purpose: 'topup', timestamp: Date.now() });
      save();
      qs('#topupModal').close();
      toast('Wallet topped up');
    });

    // Pay & Join: pay missing amount then join
    qs('#btnPayAndJoin').addEventListener('click', async () => {
      if (!ensureProfileForJoin()) return;
      const tid = qs('#joinTournId').value; const t = appState.tournaments[tid]; const user = currentUser();
      const missing = Math.max(0, t.entryFee - user.walletBalance);
      if (missing <= 0) { handleJoin(); return; }
      const ok = await processPayment(missing, 'Join Tournament');
      if (!ok) { toast('Payment failed'); return; }
      user.walletBalance += missing;
      appState.payments.push({ id: uid(), userId: user.id, amount: missing, purpose: 'join-topup', timestamp: Date.now() });
      save();
      handleJoin();
    });

    // Payment gateway placeholder (Razorpay/Stripe)
    async function processPayment(amount, description) {
      const method = appState.settings.paymentGateway || 'razorpay';
      if (method === 'razorpay' && appState.settings.razorpayKey) {
        await loadScriptOnce('https://checkout.razorpay.com/v1/checkout.js', 'rzp-checkout');
        return new Promise((resolve) => {
          try {
            const rzp = new window.Razorpay({
              key: appState.settings.razorpayKey,
              amount: Math.round(amount * 100),
              currency: 'INR',
              name: 'Free Fire Tourneys',
              description,
              handler: () => resolve(true),
              modal: { ondismiss: () => resolve(false) }
            });
            rzp.open();
          } catch { resolve(false); }
        });
      }
      // Stripe placeholder (requires backend to create PaymentIntent)
      if (method === 'stripe' && appState.settings.stripeKey) {
        // TODO: integrate Stripe.js here
      }
      // Fallback mock payment
      return new Promise(res => setTimeout(() => res(true), 800));
    }

    async function loadScriptOnce(src, id) {
      if (id && document.getElementById(id)) return true;
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        if (id) s.id = id; s.src = src; s.onload = () => resolve(true); s.onerror = reject; document.head.appendChild(s);
      });
    }

    // Initial render
    function renderAll() {
      // Update visible tab content
      const active = qsa('.tabs').find(s => s.classList.contains('active'));
      if (!active) return;
      if (active.id === 'tournaments') renderTournaments();
      if (active.id === 'refer') renderRefer();
      if (active.id === 'profile') renderProfile();
    }
    renderAll();

    // Expose placeholders for backend calls
    // User joins tournament (placeholder structure)
    async function joinTournament(tournId, userId) {
      // await processPayment(entryFee);
      // await db.collection('tournaments').doc(tournId).collection('registrations').add({ userId, timestamp: Date.now() });
      // await db.collection('users').doc(userId).update({ walletBalance: newBalance });
      return true;
    }

  </script>
</body>
</html>

